permissions:
  contents: write
name: CI for NKS via ArgoCD with Blue/Green

on:
  push:
    branches:
      - 'main'

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          persist-credentials: true
          fetch-depth: 0

      - name: í”„ë¡œì íŠ¸ ë¹Œë“œ (Jar ìƒì„±)
        run: ./gradlew clean build --no-daemon

      - name: NCP ë ˆì§€ìŠ¤íŠ¸ë¦¬ ë¡œê·¸ì¸
        uses: docker/login-action@v2
        with:
          registry: mindle.kr.ncr.ntruss.com
          username: ${{ secrets.NCP_ACCESS_KEY }}
          password: ${{ secrets.NCP_SECRET_KEY }}

      - name: QEMU ì„¤ì¹˜ (ë©€í‹°í”Œëž«í¼ ì§€ì›)
        uses: docker/setup-qemu-action@v2
        with:
          platforms: linux/amd64

      - name: Buildx ì„¤ì¹˜
        uses: docker/setup-buildx-action@v2

      - name: ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ
        env:
          IMAGE_TAG: "1.0.${{ github.run_number }}"
        run: |
          docker buildx build \
            --platform linux/amd64 \
            -t mindle.kr.ncr.ntruss.com/my-spring-app:$IMAGE_TAG \
            --push \
            .

      #  ìƒˆë¡œ ì¶”ê°€ëœ Blue/Green ë°°í¬ ë¡œì§
      - name: kubectl ì„¤ì¹˜
        run: |
          curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
          chmod +x kubectl
          sudo mv kubectl /usr/local/bin/

      - name: NCP NKS í´ëŸ¬ìŠ¤í„° ì—°ê²° ì„¤ì •
        run: |
          # NCP NKS kubeconfig ì„¤ì • (NCP CLI ì‚¬ìš© ë˜ëŠ” ì§ì ‘ ì„¤ì •)
          # ì—¬ê¸°ì— NCP NKS ì—°ê²° ì„¤ì •ì„ ì¶”ê°€í•˜ì„¸ìš”
          echo "Kubernetes cluster connection setup..."
          kubectl version --client

      - name: Blue/Green ë°°í¬ ëŒ€ìƒ í™˜ê²½ í™•ì¸
        env:
          IMAGE_TAG: "1.0.${{ github.run_number }}"
        run: |
          # í˜„ìž¬ ì„œë¹„ìŠ¤ê°€ ê°€ë¦¬í‚¤ëŠ” ìƒ‰ìƒ í™•ì¸
          CURRENT_COLOR=$(kubectl get service spring-svc -o jsonpath='{.spec.selector.color}' 2>/dev/null || echo "blue")
          
          if [ "$CURRENT_COLOR" = "blue" ]; then
            TARGET_COLOR="green"
          else
            TARGET_COLOR="blue"
          fi
          
          echo "í˜„ìž¬ í™œì„± í™˜ê²½: $CURRENT_COLOR"
          echo "ë°°í¬ ëŒ€ìƒ í™˜ê²½: $TARGET_COLOR"
          echo "ìƒˆ ì´ë¯¸ì§€: mindle.kr.ncr.ntruss.com/my-spring-app:$IMAGE_TAG"
          
          echo "TARGET_COLOR=$TARGET_COLOR" >> $GITHUB_ENV

      - name: ë¹„í™œì„± í™˜ê²½ì— ìƒˆ ì´ë¯¸ì§€ ë°°í¬
        env:
          IMAGE_TAG: "1.0.${{ github.run_number }}"
        run: |
          echo " $TARGET_COLOR í™˜ê²½ì— ìƒˆ ë²„ì „ ë°°í¬ ì‹œìž‘..."
          
          # kubectlë¡œ ì´ë¯¸ì§€ ì—…ë°ì´íŠ¸
          kubectl set image deployment/spring-app-$TARGET_COLOR \
            spring=mindle.kr.ncr.ntruss.com/my-spring-app:$IMAGE_TAG
          
          echo "â³ $TARGET_COLOR í™˜ê²½ ë°°í¬ ìƒíƒœ í™•ì¸ ì¤‘..."
          
          # ë°°í¬ ì™„ë£Œ ëŒ€ê¸° (ìµœëŒ€ 10ë¶„)
          kubectl rollout status deployment/spring-app-$TARGET_COLOR --timeout=600s
          
          echo " $TARGET_COLOR í™˜ê²½ ë°°í¬ ì™„ë£Œ!"

      - name: ìƒˆ í™˜ê²½ í—¬ìŠ¤ì²´í¬
        run: |
          echo "ðŸ” $TARGET_COLOR í™˜ê²½ í—¬ìŠ¤ì²´í¬ ì¤‘..."
          
          # Podê°€ Ready ìƒíƒœê°€ ë  ë•Œê¹Œì§€ ëŒ€ê¸° (ìµœëŒ€ 5ë¶„)
          kubectl wait --for=condition=ready pod \
            -l app=spring-app,color=$TARGET_COLOR \
            --timeout=300s
          
          # Pod ìƒíƒœ í™•ì¸
          echo " $TARGET_COLOR í™˜ê²½ Pod ìƒíƒœ:"
          kubectl get pods -l app=spring-app,color=$TARGET_COLOR
          
          echo " $TARGET_COLOR í™˜ê²½ì´ ì •ìƒ ë™ìž‘ ì¤‘ìž…ë‹ˆë‹¤!"

      - name: ë°°í¬ ì™„ë£Œ ì•ˆë‚´
        env:
          IMAGE_TAG: "1.0.${{ github.run_number }}"
        run: |
          echo " Blue/Green ë°°í¬ ì™„ë£Œ!"
          echo ""
          echo " ë°°í¬ ì •ë³´:"
          echo "   â€¢ ìƒˆ ì´ë¯¸ì§€: mindle.kr.ncr.ntruss.com/my-spring-app:$IMAGE_TAG"
          echo "   â€¢ ë°°í¬ í™˜ê²½: $TARGET_COLOR"
          echo "   â€¢ í˜„ìž¬ íŠ¸ëž˜í”½ì€ ì—¬ì „ížˆ ê¸°ì¡´ í™˜ê²½ìœ¼ë¡œ ê°€ê³  ìžˆìŠµë‹ˆë‹¤"
          echo ""
          echo " íŠ¸ëž˜í”½ ì „í™˜ì„ ì›í•˜ì‹œë©´ ë‹¤ìŒ ëª…ë ¹ì–´ë¥¼ ì‹¤í–‰í•˜ì„¸ìš”:"
          echo "   kubectl patch service spring-svc -p '{\"spec\":{\"selector\":{\"color\":\"$TARGET_COLOR\"}}}'"
          echo ""
          echo " ë¡¤ë°±ì´ í•„ìš”í•˜ì‹œë©´ ë‹¤ìŒ ëª…ë ¹ì–´ë¥¼ ì‹¤í–‰í•˜ì„¸ìš”:"
          CURRENT_COLOR=$(kubectl get service spring-svc -o jsonpath='{.spec.selector.color}')
          echo "   kubectl patch service spring-svc -p '{\"spec\":{\"selector\":{\"color\":\"$CURRENT_COLOR\"}}}'"

      #  YAML ë§¤ë‹ˆíŽ˜ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸ (ArgoCD GitOpsë¥¼ ìœ„í•´)
      - name: yq ì„¤ì¹˜
        run: |
          wget https://github.com/mikefarah/yq/releases/download/v4.46.1/yq_linux_amd64 -O yq
          chmod +x yq
          sudo mv yq /usr/local/bin/yq

      - name: ë§¤ë‹ˆíŽ˜ìŠ¤íŠ¸ íŒŒì¼ ì—…ë°ì´íŠ¸ (GitOps)
        env:
          IMAGE_TAG: "1.0.${{ github.run_number }}"
        run: |
          # ë°°í¬ëœ í™˜ê²½ì˜ YAML íŒŒì¼ ì—…ë°ì´íŠ¸
          if [ "$TARGET_COLOR" = "blue" ]; then
            DEPLOYMENT_FILE="spring-app-blue-deployment.yaml"
          else
            DEPLOYMENT_FILE="spring-app-green-deployment.yaml"
          fi
          
          # í•´ë‹¹ deployment íŒŒì¼ì´ ìžˆìœ¼ë©´ ì—…ë°ì´íŠ¸
          if [ -f "$DEPLOYMENT_FILE" ]; then
            yq e -i \
              '.spec.template.spec.containers[0].image = "mindle.kr.ncr.ntruss.com/my-spring-app:'"$IMAGE_TAG"'"' \
              $DEPLOYMENT_FILE
            echo " $DEPLOYMENT_FILE ì—…ë°ì´íŠ¸ ì™„ë£Œ"
          else
            echo "  $DEPLOYMENT_FILE íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤"
          fi

      - name: ë³€ê²½ì‚¬í•­ ì»¤ë°‹ ë° í‘¸ì‹œ
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          IMAGE_TAG: "1.0.${{ github.run_number }}"
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          
          # ë³€ê²½ëœ íŒŒì¼ì´ ìžˆëŠ”ì§€ í™•ì¸
          if git diff --quiet; then
            echo " ë³€ê²½ëœ ë§¤ë‹ˆíŽ˜ìŠ¤íŠ¸ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤"
          else
            git add .
            git commit -m "ci: deploy image $IMAGE_TAG to $TARGET_COLOR environment"
            git pull --rebase origin ${{ github.ref_name }}
            git push
            echo " GitOps ë§¤ë‹ˆíŽ˜ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸ ì™„ë£Œ"
          fi
      - name: NCP NKS í´ëŸ¬ìŠ¤í„° ì—°ê²° ì„¤ì •
        run: |
          # Option 1: NCP CLI ì‚¬ìš©
          # ncp-iam-authenticatorë‚˜ NCP CLIë¡œ kubeconfig ì„¤ì •
          
          # Option 2: ì§ì ‘ kubeconfig ì„¤ì •
          mkdir -p ~/.kube
          echo "${{ secrets.KUBECONFIG }}" | base64 -d > ~/.kube/config
          chmod 600 ~/.kube/config
          
          # ì—°ê²° í…ŒìŠ¤íŠ¸
          kubectl cluster-info
          kubectl get nodes
